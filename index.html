<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Focus Pet ‚Äî Fixed</title>

<!-- Fonts + libs -->
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg: linear-gradient(180deg,#073c35,#0a4540 40%,#05343a);
  --card: rgba(255,255,255,0.04);
  --muted:#b9d6d1;
  --accent1:#8de0c7;
  --accent2:#c3b4ff;
  --shadow: 0 10px 30px rgba(0,0,0,0.45);
  --glass: rgba(255,255,255,0.02);
}
*{box-sizing:border-box}
body{
  margin:0; font-family:'Fredoka',system-ui,Segoe UI,Roboto; color:#eaf9f4;
  background:var(--bg); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
.app{max-width:1100px;margin:18px auto;padding:18px;display:flex;gap:22px;align-items:flex-start;}
header{width:100%;display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:6px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(90deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:700;color:#053}
.brand h1{margin:0;font-size:1.05rem}
.top-cards{display:flex;gap:12px;align-items:center}
.card-mini{background:var(--card);padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);min-width:110px;text-align:center}
.label{font-size:0.8rem;color:var(--muted)}
.val{font-weight:700;font-size:1.05rem;margin-top:6px;color:#e7fff8}

.layout{display:flex;gap:24px;width:100%}
/* left column (timer) */
.col-left{width:420px;min-width:320px}
.focus-area{background:var(--glass);border-radius:18px;padding:18px;box-shadow:var(--shadow);display:flex;flex-direction:column;align-items:center;gap:12px}
.timer-card{width:360px;height:360px;border-radius:20px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00)); display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;padding:24px}
.pet-top{position:absolute;top:14px;left:50%;transform:translateX(-50%)}
lottie-player{width:150px;height:150px;display:block}
.timer-inner{text-align:center;position:absolute;bottom:26px;left:50%;transform:translateX(-50%)}
#time{font-size:2.6rem;font-weight:800;letter-spacing:1px}
#petStatus{color:var(--muted);margin-top:6px}

/* ring SVG overlay */
.ring-wrap{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
svg { width:100%; height:100% }

/* controls */
.controls{display:flex;gap:12px;margin-top:12px}
button.control{background:var(--accent1);border:none;color:#053;padding:10px 18px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:var(--shadow)}
button.control.secondary{background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--muted)}

/* right column */
.col-right{flex:1;display:flex;flex-direction:column;gap:16px}
.panel{background:var(--card);border-radius:14px;padding:14px;box-shadow:var(--shadow)}
.shop-grid{display:flex;flex-wrap:wrap;gap:10px}
.shop-item{background:rgba(255,255,255,0.02);padding:10px;border-radius:10px;width:calc(50% - 6px);text-align:center}
.shop-item img{width:80px;height:80px;object-fit:contain;border-radius:10px;display:block;margin:6px auto}

/* small responsive */
@media(max-width:880px){
  .app{padding:12px}
  .layout{flex-direction:column;align-items:center}
  .col-left,.col-right{width:100%}
}
</style>
</head>
<body>
<div class="app">
  <header style="width:100%">
    <div class="brand">
      <div class="logo">üêæ</div>
      <div>
        <h1>Focus Pet</h1>
        <div style="font-size:0.9rem;color:var(--muted)">Raise your pet by focusing!</div>
      </div>
    </div>

    <div class="top-cards">
      <div class="card-mini">
        <div class="label">Total Focus Time</div>
        <div class="val" id="totalFocusVal">0 m</div>
      </div>
      <div class="card-mini">
        <div class="label">Coins</div>
        <div class="val" id="coinCount">0</div>
      </div>
    </div>
  </header>

  <div class="layout" style="width:100%">
    <!-- LEFT: Timer -->
    <div class="col-left">
      <div class="focus-area">
        <div class="timer-card" role="region" aria-label="timer card">
          <div class="pet-top">
            <!-- public lottie file so GitHub Pages works without uploading extra files -->
            <lottie-player id="petAnim" src="https://lottie.host/8e26ef53-97c3-49f5-b9e7-6c8a2ab7a8a5/OwJKjw5mWL.json" background="transparent" speed="1" loop autoplay></lottie-player>
          </div>

          <div class="ring-wrap" aria-hidden="true">
            <svg viewBox="0 0 320 320" preserveAspectRatio="xMidYMid meet">
              <defs>
                <linearGradient id="g1"><stop offset="0" stop-color="#8de0c7"/><stop offset="1" stop-color="#c3b4ff"/></linearGradient>
              </defs>
              <circle cx="160" cy="160" r="130" stroke="rgba(255,255,255,0.03)" stroke-width="12" fill="none"></circle>
              <circle id="ring" cx="160" cy="160" r="130" stroke="url(#g1)" stroke-width="12" fill="none" stroke-linecap="round" transform="rotate(-90 160 160)"></circle>
            </svg>
          </div>

          <div class="timer-inner">
            <div id="time">00:00</div>
            <div id="petStatus">Your pet is sleepy...</div>
          </div>
        </div>

        <div class="controls" style="justify-content:center;">
          <button class="control" id="startBtn">Start</button>
          <button class="control secondary" id="pauseBtn">Pause</button>
          <button class="control" id="resetBtn">Reset</button>
        </div>
      </div>
    </div>

    <!-- RIGHT: Shop / Progress -->
    <div class="col-right">
      <div class="panel">
        <h3 style="margin-top:0">Shop</h3>
        <div class="shop-grid">
          <div class="shop-item">
            üçñ Feed<br><strong>10 coins</strong><br>
            <button class="shop-open" data-panel="feedOptions">Buy</button>
          </div>
          <div class="shop-item">
            üß∏ Play<br><strong>15 coins</strong><br>
            <button class="shop-open" data-panel="playOptions">Buy</button>
          </div>
          <div class="shop-item">
            üåà Skin<br><strong>50 coins</strong><br>
            <button id="skinBtn">Buy</button>
          </div>
          <div class="shop-item">
            ‚ú® Boost<br><strong>6 coins</strong><br>
            <button class="shop-open" data-panel="boostOptions">Buy</button>
          </div>
        </div>

        <!-- feed options -->
        <div id="feedOptions" class="panel" style="margin-top:12px;display:none">
          <h4 style="margin:6px 0">Feed Options</h4>
          <div class="shop-grid">
            <div class="shop-item">
              <img src="https://i.pinimg.com/originals/4a/32/52/4a32526ce384e43b0e8536faac321e8a.gif" alt="">
              ü•© Meat<br><strong>5 coins</strong><br>
              <button class="buyFeed" data-type="Meat" data-price="5">Buy</button>
            </div>
            <div class="shop-item">
              <img src="https://i.pinimg.com/originals/a1/ab/f8/a1abf8bad885fdaa6aaa757319c6d3ab.gif" alt="">
              ü•õ Milk<br><strong>3 coins</strong><br>
              <button class="buyFeed" data-type="Milk" data-price="3">Buy</button>
            </div>
            <div class="shop-item">
              <img src="https://i.pinimg.com/originals/ee/f6/f5/eef6f575d4195d5809716b48cd12b250.gif" alt="">
              üêü Fish<br><strong>6 coins</strong><br>
              <button class="buyFeed" data-type="Fish" data-price="6">Buy</button>
            </div>
            <div class="shop-item">
              <img src="https://i.pinimg.com/originals/3f/5d/f4/3f5df47b4aba75d25d954700f32e0a47.gif" alt="">
              üç™ Biscuits<br><strong>2 coins</strong><br>
              <button class="buyFeed" data-type="Biscuits" data-price="2">Buy</button>
            </div>
          </div>
        </div>

        <!-- play options -->
        <div id="playOptions" class="panel" style="margin-top:12px;display:none">
          <h4 style="margin:6px 0">Play Options</h4>
          <div class="shop-grid">
            <div class="shop-item">
              <img src="https://i.pinimg.com/originals/eb/2a/53/eb2a5392a056ebcfc1f9c0326d6deecf.gif" alt="">
              üéæ Ball<br><strong>8 coins</strong><br>
              <button class="buyToy" data-type="Ball" data-price="8">Buy</button>
            </div>
            <div class="shop-item">
              <img src="https://i.pinimg.com/originals/a1/62/33/a16233a2a7c65799a9e9b4c626ff865f.gif" alt="">
              üîî Bell<br><strong>6 coins</strong><br>
              <button class="buyToy" data-type="Bell" data-price="6">Buy</button>
            </div>
            <div class="shop-item">
              <img src="https://i.pinimg.com/originals/46/fc/ea/46fceaad10cc30bc7bbd74a83655a09b.gif" alt="">
              üê≠ Mouse Toy<br><strong>7 coins</strong><br>
              <button class="buyToy" data-type="Mouse Toy" data-price="7">Buy</button>
            </div>
            <div class="shop-item">
              <img src="https://i.pinimg.com/originals/4d/1a/04/4d1a0481849a8f03a4c0c08703b4c32a.gif" alt="">
              üåÄ Spinner<br><strong>10 coins</strong><br>
              <button class="buyToy" data-type="Spinner" data-price="10">Buy</button>
            </div>
          </div>
        </div>

        <!-- boost options -->
        <div id="boostOptions" class="panel" style="margin-top:12px;display:none">
          <h4 style="margin:6px 0">Boost Options</h4>
          <div class="shop-grid">
            <div class="shop-item">
              <img src="https://i.pinimg.com/originals/14/2b/56/142b56a4a2d5f8f1e2dbf4f2f7c1e3d1.gif" alt="">
              üç¨ Happy Treat<br><strong>5 coins</strong><br>
              <button class="buyBoost" data-type="Happy Treat" data-price="5">Buy</button>
            </div>
            <div class="shop-item">
              <img src="https://i.pinimg.com/originals/26/3a/7d/263a7d2f8b1d4c1e6a1c4e8b5d3a7f2b.gif" alt="">
              üü¶ Boost Buttons<br><strong>7 coins</strong><br>
              <button class="buyBoost" data-type="Boost Buttons" data-price="7">Buy</button>
            </div>
            <div class="shop-item">
              <img src="https://i.pinimg.com/originals/7f/91/2b/7f912b8e0c1b3a2f7f0c8b2f9d1e3c4a.gif" alt="">
              üéÄ Accessory Boost<br><strong>10 coins</strong><br>
              <button class="buyBoost" data-type="Accessory Boost" data-price="10">Buy</button>
            </div>
            <div class="shop-item">
              <img src="https://i.pinimg.com/originals/5c/12/ab/5c12ab7f1d3e4a8f6d5b1f2c3e6a7d1b.gif" alt="">
              üß™ Cheer Potion<br><strong>12 coins</strong><br>
              <button class="buyBoost" data-type="Cheer Potion" data-price="12">Buy</button>
            </div>
          </div>
        </div>

      </div>

      <div class="panel">
        <h3 style="margin-top:0">Progress</h3>
        <div class="period-tabs" style="display:flex;gap:8px;margin-bottom:12px">
          <button class="tab active" data-period="daily">Daily</button>
          <button class="tab" data-period="weekly">Weekly</button>
          <button class="tab" data-period="monthly">Monthly</button>
          <button class="tab" data-period="yearly">Yearly</button>
        </div>
        <div class="charts" style="align-items:stretch">
          <canvas id="barChart" width="600" height="200" style="max-width:100%"></canvas>
          <div id="weeklyAvgContainer" style="display:flex;justify-content:space-between;margin-top:10px;color:var(--muted)"><span>Weekly average</span><span id="weeklyAvg">0 min</span></div>
        </div>
      </div>
    </div> <!-- end right column -->

  </div> <!-- end layout -->
</div> <!-- end app -->

<script>
/*
  Robust unified script:
  - initializes elements safely
  - keeps ids consistent
  - handles localStorage for coins/sessions
  - closes modals when clicking outside
  - Chart.js safe init
*/

// LocalStorage keys
const LS_COINS = 'fp_coins_v1';
const LS_SESS = 'fp_sessions_v1';

// state
let secs = 0, timer = null, isRun = false, startISO = null;
let coins = parseInt(localStorage.getItem(LS_COINS) || '0', 10) || 0;
let sess = JSON.parse(localStorage.getItem(LS_SESS) || '[]');

// element refs
const timeEl = document.getElementById('time');
const coinEl = document.getElementById('coinCount');
const pet = document.getElementById('petAnim');
const statusEl = document.getElementById('petStatus');
const totalFocusVal = document.getElementById('totalFocusVal');
const ring = document.getElementById('ring');

const feedPanel = document.getElementById('feedOptions');
const playPanel = document.getElementById('playOptions');
const boostPanel = document.getElementById('boostOptions');

const startBtn = document.getElementById('startBtn');
const pauseBtn = document.getElementById('pauseBtn');
const resetBtn = document.getElementById('resetBtn');
const skinBtn = document.getElementById('skinBtn');

const shopOpenButtons = Array.from(document.querySelectorAll('.shop-open'));

// ring circumference
const R = 130;
const C = 2 * Math.PI * R;
if (ring){
  ring.style.strokeDasharray = C;
  ring.style.strokeDashoffset = C;
}

// format helpers
function fmt(s){ const m = Math.floor(s/60).toString().padStart(2,'0'); const ss = (s%60).toString().padStart(2,'0'); return `${m}:${ss}`; }
function fmtHM(t){ const h = Math.floor(t/3600), m = Math.floor((t%3600)/60); return h>0? `${h} h ${m} m` : `${m} m`; }
function totalSecs(){ return (sess.reduce((a,b)=>a+b.secs,0) || 0) + secs; }

// display update
function updDisp(){
  timeEl.textContent = fmt(secs);
  if (ring) ring.style.strokeDashoffset = C - (secs % 60)/60 * C;
  coinEl.textContent = coins;
  totalFocusVal.textContent = fmtHM(totalSecs());
  updPetState();
}

// pet visuals based on secs
function updPetState(){
  if (!pet) return;
  if (secs < 30){ try{ pet.setSpeed(0.6); }catch(e){} statusEl.textContent='Your pet is sleepy...'; }
  else if (secs < 60){ try{ pet.setSpeed(1); }catch(e){} statusEl.textContent='Your pet is waking up!'; }
  else{ try{ pet.setSpeed(1.5); }catch(e){} statusEl.textContent='Your pet is super happy!'; }
}

// timer controls
function startT(){
  if (isRun) return;
  isRun = true;
  if (!startISO) startISO = new Date().toISOString();
  timer = setInterval(()=>{
    secs++;
    // reward coin every 10s
    if (secs % 10 === 0){
      coins++;
      localStorage.setItem(LS_COINS, coins);
    }
    updDisp();
  },1000);
}
function pauseT(){ if (!isRun) return; isRun = false; clearInterval(timer); timer=null; updDisp(); }
function resetT(){
  if (secs > 0 && startISO){
    sess.push({ startISO, secs });
    localStorage.setItem(LS_SESS, JSON.stringify(sess));
  }
  secs = 0; startISO = null; isRun = false; clearInterval(timer); timer=null;
  updDisp(); drawChart(); 
}

// bind timer buttons safely
if (startBtn) startBtn.addEventListener('click', startT);
if (pauseBtn) pauseBtn.addEventListener('click', pauseT);
if (resetBtn) resetBtn.addEventListener('click', resetT);

// react helper
function react(spd, txt){
  try{ if (pet && pet.setSpeed) pet.setSpeed(spd); }catch(e){}
  if (statusEl) statusEl.textContent = txt;
  setTimeout(()=>updPetState(), 3000);
}

// shop open toggles
shopOpenButtons.forEach(btn=>{
  btn.addEventListener('click', ()=> {
    const p = btn.dataset.panel;
    togglePanel(p);
  });
});
function togglePanel(id){
  // hide others
  [feedPanel, playPanel, boostPanel].forEach(p => { if (p && p.id !== id) p.style.display = 'none'; });
  const el = document.getElementById(id);
  if (!el) return;
  el.style.display = (el.style.display === 'block') ? 'none' : 'block';
}

// close panels on outside click
window.addEventListener('click', (e)=>{
  // if clicked inside any panel or any shop-open button -> do nothing
  if (e.target.closest('.panel') || e.target.closest('.shop-open') || e.target.closest('.buyFeed') || e.target.closest('.buyToy') || e.target.closest('.buyBoost')) return;
  // else hide feed/play/boost panels
  [feedPanel, playPanel, boostPanel].forEach(p => { if (p) p.style.display = 'none'; });
});

// skin & boost & buy logic (delegated)
if (skinBtn){
  skinBtn.addEventListener('click', ()=>{
    if (coins >= 50){ coins -= 50; localStorage.setItem(LS_COINS, coins); updDisp(); react(1.8,'New look!'); }
    else alert('Not enough coins');
  });
}

// buy handlers
function attachBuyListeners(){
  document.querySelectorAll('.buyFeed').forEach(btn=>{
    btn.onclick = ()=>{
      const price = parseInt(btn.dataset.price,10) || 0;
      const type = btn.dataset.type || 'Food';
      if (coins >= price){
        coins -= price; localStorage.setItem(LS_COINS, coins); updDisp(); react(1.8, `${type} eaten!`);
      } else alert('Not enough coins');
    };
  });
  document.querySelectorAll('.buyToy').forEach(btn=>{
    btn.onclick = ()=>{
      const price = parseInt(btn.dataset.price,10) || 0;
      const type = btn.dataset.type || 'Toy';
      if (coins >= price){
        coins -= price; localStorage.setItem(LS_COINS, coins); updDisp(); react(2, `${type} played!`);
      } else alert('Not enough coins');
    };
  });
  document.querySelectorAll('.buyBoost').forEach(btn=>{
    btn.onclick = ()=>{
      const price = parseInt(btn.dataset.price,10) || 0;
      const type = btn.dataset.type || 'Boost';
      if (coins >= price){
        coins -= price; localStorage.setItem(LS_COINS, coins); updDisp();
        switch(type){
          case 'Happy Treat': react(2,'Yum! Happy Treat!'); break;
          case 'Boost Buttons': react(2.2,'Excited with Boost Buttons!'); break;
          case 'Accessory Boost': react(1.8,'Looking fabulous with Accessory!'); break;
          case 'Cheer Potion': react(2.5,'Feeling super cheered!'); break;
          default: react(1.8, `${type} used!`);
        }
      } else alert('Not enough coins');
    };
  });
}

// Chart functions - safe
let curPeriod = 'daily';
const barCtxEl = document.getElementById('barChart');
let barChart = null;

function agg(){
  const m = {};
  for (const s of sess){
    const d = new Date(s.startISO);
    if (!isNaN(d)){
      const k = d.toISOString().split('T')[0];
      m[k] = (m[k] || 0) + (s.secs || 0);
    }
  }
  return m;
}
function daysAgo(n){
  const d = new Date(); d.setDate(d.getDate()-n); return d;
}
function weekly(m){
  const labels = [], data = [];
  for (let i=6;i>=0;i--){
    const d = daysAgo(i);
    const k = d.toISOString().split('T')[0];
    labels.push(d.toLocaleDateString(undefined,{weekday:'short'}));
    data.push(Math.round((m[k]||0)/60));
  }
  return {labels, data};
}
function monthly(m){
  const labels = [], data = [];
  const n = new Date();
  for (let i=5;i>=0;i--){
    const d = new Date(n.getFullYear(), n.getMonth()-i, 1);
    labels.push(d.toLocaleDateString(undefined,{month:'short'}));
    let t = 0;
    for (const k in m){
      const dt = new Date(k);
      if (dt.getMonth()===d.getMonth() && dt.getFullYear()===d.getFullYear()) t+=m[k];
    }
    data.push(Math.round(t/60));
  }
  return {labels, data};
}
function yearly(m){
  const labels = [], data = [];
  const n = new Date();
  for (let i=4;i>=0;i--){
    const y = n.getFullYear()-i;
    labels.push(String(y));
    let t = 0;
    for (const k in m){
      const dt = new Date(k);
      if (dt.getFullYear() === y) t+=m[k];
    }
    data.push(Math.round(t/60));
  }
  return {labels, data};
}
function getBars(p){
  const m = agg();
  if (p === 'daily' || p === 'weekly') return weekly(m);
  if (p === 'monthly') return monthly(m);
  return yearly(m);
}
function drawChart(){
  try{
    const b = getBars(curPeriod);
    if (!barCtxEl) return;
    if (barChart) { barChart.destroy(); barChart = null; }
    barChart = new Chart(barCtxEl.getContext('2d'), {
      type:'bar',
      data:{ labels: b.labels, datasets: [{ data: b.data, backgroundColor: '#8de0c7' }] },
      options:{ plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true } } }
    });
    const w = (weekly(agg()).data.reduce((a,b)=>a+b,0) || 0) / 7;
    const wa = document.getElementById('weeklyAvg');
    if (wa) wa.textContent = w.toFixed(1) + ' min';
  } catch(e){
    console.warn('chart error', e);
  }
}

// tab handlers
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    curPeriod = t.dataset.period;
    drawChart();
  });
});

// init
function init(){
  // restore
  coins = parseInt(localStorage.getItem(LS_COINS) || '0', 10) || 0;
  sess = JSON.parse(localStorage.getItem(LS_SESS) || '[]') || [];
  updDisp();
  attachBuyListeners();
  drawChart();
}
init();

// Expose some helpers to console for debugging (if user wants)
window._fp = { startT, pauseT, resetT, updDisp, drawChart, state: ()=>({secs,coins,sess}) };

</script>
</body>
</html>
